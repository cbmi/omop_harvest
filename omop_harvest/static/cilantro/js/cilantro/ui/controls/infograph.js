define(["jquery","underscore","backbone","marionette","./base"],function(t,e,i,n,s){var o=function(t){return function(i){var n=i.get(t);return e.isString(n)&&(n=n.toLowerCase()),n}},r=i.Model.extend({parse:function(t){return t.value=t.values[0],t}}),a=i.Collection.extend({model:r,comparator:function(t){return-t.get("count")},sortModelsBy:function(t){var e=t.chartAt(0);"-"===e&&(t=t.slice(1)),this.models=this.sortBy(o(t)),"-"===e&&this.models.reverse(),this.trigger("sort",this)}}),l=n.ItemView.extend({className:"info-bar",template:"controls/infograph/bar",options:{total:null},ui:{bar:".bar",barLabel:".bar-label"},events:{click:"toggleSelected"},modelEvents:{"change:selected":"setSelected","change:visible":"setVisible"},initialize:function(){e.bindAll(this,"onExcludedChange"),this.listenTo(this.model.collection,"change:excluded",this.onExcludedChange)},serializeData:function(){var t=this.model.toJSON();t.value=t.values[0];var e=this.getPercentage();return t.width=e,t.percentage=1>e?"<1":parseInt(e),t},onRender:function(){this.setSelected(this.model,!!this.model.get("selected")),""===this.ui.barLabel.html()&&this.ui.barLabel.html("(empty)"),"null"===this.ui.barLabel.html()&&this.ui.barLabel.html("(null)")},getPercentage:function(){return 100*(this.model.get("count")/this.options.total)},toggleSelected:function(){this.model.set("selected",!this.model.get("selected"))},onExcludedChange:function(){this.$el.toggleClass("excluded",this.model.get("excluded"))},setSelected:function(t,e){this.$el.toggleClass("selected",e),e||t.get("visible")!==!1||this.$el.removeClass("filtered").hide()},setVisible:function(t,e){e?this.$el.removeClass("filtered").show():t.get("selected")?this.$el.addClass("filtered"):this.$el.hide()}}),c=s.ControlCollectionView.extend({className:"info-bar-chart",itemView:l,itemViewOptions:function(t){return{model:t,total:this.calcTotal()}},collectionEvents:{change:"change",sort:"sortChildren"},initialize:function(){this.wait();var t=this;this.model.distribution(function(e){t.collection.reset(e.data,{parse:!0}),t.ready()})},calcTotal:function(){for(var t=0,e=this.collection.pluck("count"),i=0;i<e.length;i++)t+=e[i];return t},sortChildren:function(){var t=this;this.collection.each(function(e){var i=t.collection.findByModel(e);t.$el.append(i.el)})},getField:function(){return this.model.id},getOperator:function(){return this.collection.where({excluded:!0}).length>0?"-in":"in"},getValue:function(){return e.map(this.collection.where({selected:!0}),function(t){return t.get("value")})},setValue:function(t){t||(t=[]),this.collection.each(function(e){var i=e.get("value");e.set("selected",t.indexOf(i)>=0)})},setOperator:function(e){"-in"===e&&(this.collection.each(function(t){t.set("excluded",!0)}),t("input[name=exclude]").attr("checked",!0))}}),h=n.ItemView.extend({className:"navbar navbar-toolbar",template:"controls/infograph/toolbar",events:{"keyup [name=filter]":"filterBars","click [name=invert]":"invertSelection","click .sort-value-header, .sort-count-header":"sortBy","change [name=exclude]":"excludeCheckboxChanged"},ui:{toolbar:".btn-toolbar",filterInput:"[name=filter]",invertButton:"[name=invert]",sortValueHeader:".sort-value-header",sortCountHeader:".sort-count-header",excludeCheckbox:"[name=exclude]"},initialize:function(){this.sortDirection="-count"},sortBy:function(t){switch(this.sortDirection="sort-value-header"===t.currentTarget.className?"-value"===this.sortDirection?"value":"-value":"-count"===this.sortDirection?"count":"-count",this.sortDirection){case"-count":this.ui.sortValueHeader.html("Value <i class=icon-sort></i>"),this.ui.sortCountHeader.html("Count <i class=icon-sort-down></i>");break;case"count":this.ui.sortValueHeader.html("Value <i class=icon-sort></i>"),this.ui.sortCountHeader.html("Count <i class=icon-sort-up></i>");break;case"-value":this.ui.sortValueHeader.html("Value <i class=icon-sort-down></i>"),this.ui.sortCountHeader.html("Count <i class=icon-sort></i>");break;case"value":this.ui.sortValueHeader.html("Value <i class=icon-sort-up></i>"),this.ui.sortCountHeader.html("Count <i class=icon-sort></i>")}this.collection.sortModelsBy(this.sortDirection)},toggle:function(t){this.ui.filterInput.toggle(t),this.ui.invertButton.toggle(t),this.ui.sortValueHeader.toggle(t),this.ui.sortCountHeader.toggle(t)},filterBars:function(t){var i;e.isString(t)?i=t:(null!==t&&t.stopPropagation(),i=this.ui.filterInput.val());var n=new RegExp(i,"i");this.collection.each(function(t){t.set("visible",!i||n.test(t.get("value")))})},invertSelection:function(){this.collection.each(function(t){(t.get("visible")!==!1||t.get("selected"))&&t.set("selected",!t.get("selected"))}),this.collection.trigger("change")},excludeCheckboxChanged:function(){var t=this.ui.excludeCheckbox.prop("checked");this.collection.each(function(e){e.set("excluded",t,{silent:!0})}),this.collection.trigger("change:excluded")}}),u=s.ControlLayout.extend({template:"controls/infograph/layout",events:{change:"change"},options:{minValuesForToolbar:10},regions:{bars:".bars-region",toolbar:".toolbar-region"},ui:{loading:"[data-target=loading-indicator]"},collectionEvents:{reset:"toggleToolbar"},initialize:function(){e.bindAll(this,"toggleToolbar")},constructor:function(t){t.collection||(t.collection=new a),s.ControlLayout.prototype.constructor.apply(this,arguments),this.barsControl=new c({model:this.model,collection:this.collection});var i=this,n=["set","get","when","ready","wait"],o=function(t){return i[t]=function(){var e=i.barsControl;return e[t].call(e,arguments)},i[t]};e.each(n,function(t){o(t)}),this.listenTo(this.barsControl,"all",function(){var t=arguments[0];("change"===t||"beforeready"===t||"ready"===t)&&this.trigger.apply(this,arguments),"ready"===t&&this.ui.loading.hide()})},toggleToolbar:function(){this.toolbar.currentView&&this.toolbar.currentView.toggle(this.collection.length>=this.options.minValuesForToolbar)},onRender:function(){this.bars.show(this.barsControl),this.toolbar.show(new h({collection:this.collection})),this.toggleToolbar()},validate:function(t){return e.isUndefined(t.value)||0===t.value.length?"Select at least one value":void 0}});return{InfographControl:u}});
//@ sourceMappingURL=infograph.js.map